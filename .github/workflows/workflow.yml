name: Flutter Test & Analyze
on: [push]

jobs:
  # name: clone submodule
  #   uses: actions/checkout@v2
  update_submodules:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v2

      - name: checkout submodule
        with:
          repository: regentmarkets/binary-websocket-api
          ssh-key: ${{ secrets.SSH_KEY }}
          persist-credentials: true
      - run: |
          git submodule init
          git submodule update

      # - name: Set up SSH for submodule
      #   with:
      #     persist-credentials: true
      #   run: |
      #     mkdir -p ~/.ssh
      #     echo "${{ secrets.SUBMODULE_SSH_KEY }}" > ~/.ssh/id_rsa
      #     chmod 600 ~/.ssh/id_rsa
      #     eval $(ssh-agent -s)
      #     ssh-add ~/.ssh/id_rsa
      #     ssh-keyscan github.com >> ~/.ssh/known_hosts
      #   env:
      #     SUBMODULE_SSH_KEY: ${{ secrets.SUBMODULE_SSH_KEY }}
      # - name: setup CI step
      #   uses: regentmarkets/github-actions/ci-setup@master
      #   with:
      #     read_github_ssh_key: ${{ secrets.READ_GITHUB_SSH_KEY }}
      # - name: Update submodules
      #   # with:
      #   #   read_github_ssh_key: ${{ secrets.READ_GITHUB_SSH_KEY }}
      #   #   repository: ${{ github.repository }}
      #   with:
      #     repository: regentmarkets/binary-websocket-api
      #     ssh-key: ${{ secrets.SSH_KEY }}
      #     persist-credentials: true
      #   run: |
      #     git submodule update --init --recursive --remote
      # env:
      #   GIT_SSH_COMMAND: "ssh -o UserKnownHostsFile=/dev/null -o StrictHostKeyChecking=no"

  fetch_json_data:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - run: ./setup.sh
  generate_models:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - uses: subosito/flutter-action@v1
        with:
          channel: "stable"
      - run: flutter pub get
      - run: flutter pub run build_runner build --delete-conflicting-outputs
  test_and_analyze:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - uses: subosito/flutter-action@v1
        with:
          channel: "stable"
      - run: flutter pub get
      - run: flutter test
      - run: flutter analyze
  #   ssh-key: ${{ secrets.SSH_KEY }}
  # run: |
  #   mkdir -p ~/.ssh
  #   echo "${{ secrets.SUBMODULE_SSH_KEY }}" > ~/.ssh/id_rsa
  #   chmod 600 ~/.ssh/id_rsa
  #   ssh-keyscan github.com >> ~/.ssh/known_hosts
